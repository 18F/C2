#!/bin/sh

# Blue-green deployment script. Usage:
#
#   ./script/deploy <appname>
#
# Based on
#   http://www.cloudfoundry.rocks/blue-green-deployment-with-cloudfoundry/
#   http://docs.pivotal.io/pivotalcf/devguide/deploy-apps/blue-green.html
#   https://github.com/dlapiduz/step-cloud-foundry-deploy/blob/master/run.sh

set -e
set -x

PRIMARY=$1
SECONDARY="${PRIMARY}-B"

# pull the up-to-date manifest from the "blue" application
MANIFEST=$(mktemp -t "${PRIMARY}_manifest")
cf create-app-manifest $PRIMARY -p $MANIFEST

DOMAIN=$(cat $MANIFEST | grep domain: | awk '{print $2}')

# create the "green" application
cf push $SECONDARY -f $MANIFEST -n $SECONDARY
# ensure it starts
curl --fail -I "https://${SECONDARY}.${DOMAIN}"

# add the "green" application to the "blue" load balancer
cf map-route $SECONDARY $DOMAIN -n $PRIMARY

# cleanup
# TODO consider 'stop'-ing the PRIMARY instead so that depedencies are cached for next time
cf delete $PRIMARY -f
cf rename $SECONDARY $PRIMARY
cf delete-route $DOMAIN -n $SECONDARY -f

echo "DONE"
